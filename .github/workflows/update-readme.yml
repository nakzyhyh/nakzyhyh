name: ğŸ”„ Update README with Feedback

on:
  schedule:
    - cron: '*/30 * * * *'  # alle 30 Minuten
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Generate Feedback Block
        run: |
          echo "ğŸ” Hole Issues mit Label 'feedback'..."
          FEEDBACK=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues?labels=feedback\&state=open\&per_page=5 | \
            jq -r '.[] | "- [#" + (.number|tostring) + "](" + .html_url + ") â€“ " + .title')

          echo "âœï¸ Erstelle neuen Block..."
          echo "<!-- FEEDBACK-START -->" > feedback.md
          echo "## ğŸ’¬ Community-Feedback & Ideen" >> feedback.md
          echo "" >> feedback.md
          echo "Haben Sie eine Idee fÃ¼r ein neues Feature oder eine Frage zu meinen Projekten? Ich freue mich Ã¼ber jeden Input! Erstellen Sie einfach ein **[neues Issue](https://github.com/${{ github.repository }}/issues/new/choose)** und versehen Sie es mit dem \`feedback\`-Label." >> feedback.md
          echo "" >> feedback.md
          echo "### ğŸ”„ Neueste Feedback-Ideen:" >> feedback.md
          if [[ -z "$FEEDBACK" ]]; then
            echo "*Aktuell liegen keine offenen Feedback-VorschlÃ¤ge vor.*" >> feedback.md
          else
            echo "$FEEDBACK" >> feedback.md
          fi
          echo "" >> feedback.md
          echo "*Wird alle 30 Minuten automatisch aktualisiert...*" >> feedback.md
          echo "<!-- FEEDBACK-END -->" >> feedback.md

      - name: Update README.md
        run: |
          echo "ğŸ” Ersetze Feedback-Block in README.md..."
          awk '
            BEGIN { found=0 }
            /^<!-- FEEDBACK-START -->/ { print; while ((getline line < "feedback.md") > 0) print line; found=1; skip=1; next }
            /^<!-- FEEDBACK-END -->/ { skip=0; next }
            skip == 0 { print }
          ' README.md > README_tmp.md
          mv README_tmp.md README.md

      - name: Commit and Push if Changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "ğŸ”„ Update feedback block"
          git push
